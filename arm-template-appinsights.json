{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appName": {
      "type": "string"
    },
	"adminEmail": {
	  "type": "string"
	}
  },
  "variables": {
    "insights": "[concat(parameters('appName'), '-insights')]",
    "queryDataSource": "[resourceId('microsoft.insights/components', variables('insights'))]",
    "odataType": "Microsoft.WindowsAzure.Management.Monitoring.Alerts.Models.Microsoft.AppInsights.Nexus.DataContracts.Resources.ScheduledQueryRules.AlertingAction",
    "actionGroups": "[array(concat('/subscriptions/a7b6f428-0ed2-4721-9548-d17c361d9b77/resourceGroups/', parameters('appName'), '/providers/microsoft.insights/actiongroups/Email'))]",
    "northEuropeLocation": "northeurope",
    "brazilLocation": "latam-br-gru-edge",
    "pingTestName": "Ping",
	"pingTestAlertName": "PingTestAlert",
    "webTest": "[concat('<WebTest         Name=\"Ping\"         Id=\"b0393e9f-a600-44a5-aa51-f4e476e1f035\"         Enabled=\"True\"         CssProjectStructure=\"\"         CssIteration=\"\"         Timeout=\"120\"         WorkItemIds=\"\"         xmlns=\"http://microsoft.com/schemas/VisualStudio/TeamTest/2010\"         Description=\"\"         CredentialUserName=\"\"         CredentialPassword=\"\"         PreAuthenticate=\"True\"         Proxy=\"default\"         StopOnError=\"False\"         RecordedResultFile=\"\"         ResultsLocale=\"\">        <Items>        <Request         Method=\"GET\"         Guid=\"aabc2a3e-4aca-b7cd-bc59-b3de14b18738\"         Version=\"1.1\"         Url=\"http://', parameters('appName'), '.azurewebsites.net\"         ThinkTime=\"0\"         Timeout=\"120\"         ParseDependentRequests=\"False\"         FollowRedirects=\"True\"         RecordResult=\"True\"         Cache=\"False\"         ResponseTimeGoal=\"0\"         Encoding=\"utf-8\"         ExpectedHttpStatusCode=\"200\"         ExpectedResponseUrl=\"\"         ReportingName=\"\"         IgnoreHttpStatusCode=\"False\" />        </Items>        </WebTest>')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/actionGroups",
      "name": "Email",
      "apiVersion": "2018-03-01",
      "location": "Global",
      "properties": {
        "groupShortName": "Email",
        "enabled": true,
        "emailReceivers": [
          {
            "name": "Send Email_-EmailAction-",
            "emailAddress": "[parameters('adminEmail')]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "kind": "web",
      "name": "[variables('insights')]",
      "location": "[variables('northEuropeLocation')]",
      "apiVersion": "2014-04-01",
      "scale": null,
      "properties": {
        "name": "[variables('insights')]"
      }
    },
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "name": "Exceptions",
      "apiVersion": "2018-04-16",
      "location": "[variables('northEuropeLocation')]",
      "tags": {
        "[concat('hidden-link:/subscriptions/a7b6f428-0ed2-4721-9548-d17c361d9b77/resourcegroups/', parameters('appName'), '/providers/microsoft.insights/components/', variables('insights'))]": "Resource"
      },
      "properties": {
        "description": "Any exceptions happening in the app",
        "enabled": "true",
        "source": {
          "query": "exceptions",
          "authorizedResources": [],
          "dataSourceId": "[variables('queryDataSource')]",
          "queryType": "ResultCount"
        },
        "schedule": {
          "frequencyInMinutes": 5,
          "timeWindowInMinutes": 5
        },
        "action": {
          "odata.type": "[variables('odataType')]",
          "severity": "4",
          "aznsAction": {
            "actionGroup": "[variables('actionGroups')]",
            "emailSubject": "Check Your Exceptions"
          },
          "trigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 0
          }
        }
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('insights'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "name": "Requests",
      "apiVersion": "2018-04-16",
      "location": "[variables('northEuropeLocation')]",
      "tags": {
        "[concat('hidden-link:/subscriptions/a7b6f428-0ed2-4721-9548-d17c361d9b77/resourcegroups/', parameters('appName'), '/providers/microsoft.insights/components/', variables('insights'))]": "Resource"
      },
      "properties": {
        "description": "All the requests sent to the service",
        "enabled": "true",
        "source": {
          "query": "requests | where (operation_SyntheticSource != 'Application Insights Availability Monitoring') and (operation_Name != 'GET /favicon.ico' and operation_Name != 'GET /index.html' and operation_Name != 'GET /robots.txt' and operation_Name != 'GET /js/vendors.js' and operation_Name != 'GET /js/app.js' and operation_Name != 'GET /sitemap.xml')",
          "authorizedResources": [],
          "dataSourceId": "[variables('queryDataSource')]",
          "queryType": "ResultCount"
        },
        "schedule": {
          "frequencyInMinutes": 30,
          "timeWindowInMinutes": 30
        },
        "action": {
          "odata.type": "[variables('odataType')]",
          "severity": "2",
          "aznsAction": {
            "actionGroup": "[variables('actionGroups')]",
            "emailSubject": "Check Your Requests"
          },
          "trigger": {
            "thresholdOperator": "GreaterThan",
            "threshold": 0
          }
        }
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('insights'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/webtests",
      "name": "[variables('pingTestName')]",
      "apiVersion": "2014-04-01",
      "location": "[variables('northEuropeLocation')]",
	  "tags": {
		"[concat('hidden-link:', resourceId('Microsoft.Insights/components', variables('insights')))]": "Resource"
      },
      "properties": {
        "syntheticMonitorId": "[variables('pingTestName')]",
        "name": "[variables('pingTestName')]",
        "enabled": true,
        "frequency": 300,
        "timeout": 120,
        "kind": "ping",
        "locations": [ 
          {
            "id": "[variables('brazilLocation')]"
          }
        ],
        "configuration": {
          "webTest": "[variables('webTest')]"
        }
      },
	  "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('insights'))]"
      ]
    },
	{
	  "type": "microsoft.insights/metricalerts",
      "name": "[variables('pingTestAlertName')]",
	  "apiVersion": "2018-03-01",
	  "location": "global",
      "tags": {
        "[concat('hidden-link:', resourceId('Microsoft.Insights/components', variables('insights')))]": "Resource",
        "[concat('hidden-link:', resourceId('Microsoft.Insights/webtests', variables('pingTestName')))]": "Resource"
      },
	  "properties": {
	    "severity": 0,
	    "enabled": true,
	    "scopes": [
	  	  "[resourceId('Microsoft.Insights/webtests', variables('pingTestName'))]",
	  	  "[resourceId('Microsoft.Insights/components', variables('insights'))]"
	    ],
	    "evaluationFrequency": "PT1M",
	    "windowSize": "PT5M",
	    "criteria": {
	      "odata.type": "Microsoft.Azure.Monitor.WebtestLocationAvailabilityCriteria",
	  	  "webTestId": "[resourceId('Microsoft.Insights/webtests', variables('pingTestName'))]",
	  	  "componentId": "[resourceId('Microsoft.Insights/components', variables('insights'))]",
	  	  "failedLocationCount": 1
	    },
	    "actions": [
	  	  {
	  	    "actionGroupId": "[resourceId('microsoft.insights/actionGroups', 'Email')]"
	  	  }
	    ]
	  },
	  "dependsOn": [
	  	"[resourceId('microsoft.insights/webtests', variables('pingTestName'))]"
	  ]
	}
  ],
  "outputs": {
    "key": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Insights/components/', variables('insights'))).InstrumentationKey]"
    }
  }
}
